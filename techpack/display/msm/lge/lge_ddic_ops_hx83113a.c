#define pr_fmt(fmt)	"[Display][hx83113a-ops:%s:%d] " fmt, __func__, __LINE__

#include "dsi_panel.h"
#include "lge_ddic_ops_helper.h"
#include "cm/lge_color_manager.h"
#if defined(CONFIG_MFD_DW8768)
#include <linux/mfd/dw8768.h>
#endif

extern int lge_ddic_dsi_panel_tx_cmd_set(struct dsi_panel *panel,
				enum lge_ddic_dsi_cmd_set_type type);
extern int lge_mdss_dsi_panel_cmd_read(struct dsi_panel *panel,
					u8 cmd, int cnt, char* ret_buf);
extern char* get_payload_addr(struct dsi_panel *panel, enum lge_ddic_dsi_cmd_set_type type, int position);
extern int get_payload_cnt(struct dsi_panel *panel, enum lge_ddic_dsi_cmd_set_type type, int position);
extern int lge_backlight_device_update_status(struct backlight_device *bd);

const struct drs_res_info hx83113a_res[3] = {
	{"fhd", 0, 1080, 2400},
};

#define IDX_RED_CTRL 3
#define IDX_GREEN_CTRL 5
#define IDX_BLUE_CTRL 7
#define REG_RGB_CTRL 0xC1

#define START_DG_CTRL 1
#define DG_CMD_COUNT 46
#define TOT_PARAM_COUNT 58

#define STEP_DG_PRESET 5
#define NUM_DG_PRESET  22

static int rgb_preset[STEP_DG_PRESET][RGB_ALL] = {
	{7,  0, 17},
	{7,  2, 17},
	{2,  0, 12},
	{2,  2, 12},
	{2,  5, 12}
};

static char rgb_values[NUM_DG_PRESET][DG_CMD_COUNT] = {
	{0x00, 0x04, 0x08, 0x0C, 0x10, 0x14, 0x18, 0x1C, 0x20, 0x24, 0x28, 0x2C,
	 0x30, 0x34, 0x38, 0x3C, 0x40, 0x44, 0x48, 0x4C, 0x54, 0x5C, 0x64, 0x6C,
	 0x74, 0x7C, 0x84, 0x8C, 0x94, 0x9C, 0xA4, 0xAC, 0xB4, 0xBC, 0xC4, 0xCC,
	 0xD4, 0xDC, 0xE4, 0xEC, 0xF4, 0xF8, 0xFA, 0xFC, 0xFE, 0xFF}, // LUT Num 1, L255

	{0x00, 0x04, 0x08, 0x0C, 0x10, 0x14, 0x18, 0x1C, 0x20, 0x24, 0x28, 0x2C,
	 0x30, 0x34, 0x38, 0x3C, 0x3F, 0x43, 0x47, 0x4B, 0x53, 0x5B, 0x63, 0x6B,
	 0x73, 0x7B, 0x83, 0x8B, 0x93, 0x9B, 0xA3, 0xAB, 0xB3, 0xBB, 0xC2, 0xCA,
	 0xD2, 0xDA, 0xE2, 0xEA, 0xF2, 0xF6, 0xF8, 0xFA, 0xFC, 0xFD}, // LUT Num 2, L253

	{0x00, 0x04, 0x08, 0x0C, 0x10, 0x14, 0x18, 0x1C, 0x1F, 0x23, 0x27, 0x2B,
	 0x2F, 0x33, 0x37, 0x3B, 0x3F, 0x43, 0x47, 0x4B, 0x53, 0x5B, 0x62, 0x6A,
	 0x72, 0x7A, 0x82, 0x8A, 0x92, 0x9A, 0xA1, 0xA9, 0xB1, 0xB9, 0xC1, 0xC9,
	 0xD1, 0xD9, 0xE0, 0xE8, 0xF0, 0xF4, 0xF6, 0xF8, 0xFA, 0xFB}, // LUT Num 3, L251

	{0x00, 0x04, 0x08, 0x0C, 0x10, 0x14, 0x17, 0x1B, 0x1F, 0x23, 0x27, 0x2B,
	 0x2F, 0x33, 0x37, 0x3B, 0x3E, 0x42, 0x46, 0x4A, 0x52, 0x5A, 0x62, 0x69,
	 0x71, 0x79, 0x81, 0x89, 0x91, 0x98, 0xA0, 0xA8, 0xB0, 0xB8, 0xBF, 0xC7,
	 0xCF, 0xD7, 0xDF, 0xE6, 0xEE, 0xF2, 0xF4, 0xF6, 0xF8, 0xF9}, // LUT Num 4, L249

	{0x00, 0x04, 0x08, 0x0C, 0x0F, 0x13, 0x17, 0x1B, 0x1F, 0x23, 0x27, 0x2B,
	 0x2E, 0x32, 0x36, 0x3A, 0x3E, 0x42, 0x46, 0x4A, 0x51, 0x59, 0x61, 0x69,
	 0x70, 0x78, 0x80, 0x88, 0x8F, 0x97, 0x9F, 0xA7, 0xAE, 0xB6, 0xBE, 0xC6,
	 0xCD, 0xD5, 0xDD, 0xE5, 0xEC, 0xF0, 0xF2, 0xF4, 0xF6, 0xF7}, // LUT Num 5, L247

	{0x00, 0x04, 0x08, 0x0C, 0x0F, 0x13, 0x17, 0x1B, 0x1F, 0x23, 0x26, 0x2A,
	 0x2E, 0x32, 0x36, 0x3A, 0x3D, 0x41, 0x45, 0x49, 0x51, 0x58, 0x60, 0x68,
	 0x6F, 0x77, 0x7F, 0x87, 0x8E, 0x96, 0x9E, 0xA5, 0xAD, 0xB5, 0xBC, 0xC4,
	 0xCC, 0xD3, 0xDB, 0xE3, 0xEA, 0xEE, 0xF0, 0xF2, 0xF4, 0xF5}, // LUT Num 6, L245

	{0x00, 0x04, 0x08, 0x0B, 0x0F, 0x13, 0x17, 0x1B, 0x1E, 0x22, 0x26, 0x2A,
	 0x2E, 0x32, 0x35, 0x39, 0x3D, 0x41, 0x45, 0x48, 0x50, 0x58, 0x5F, 0x67,
	 0x6F, 0x76, 0x7E, 0x85, 0x8D, 0x95, 0x9C, 0xA4, 0xAC, 0xB3, 0xBB, 0xC2,
	 0xCA, 0xD2, 0xD9, 0xE1, 0xE9, 0xEC, 0xEE, 0xF0, 0xF2, 0xF3}, // LUT Num 7, L243

	{0x00, 0x04, 0x08, 0x0B, 0x0F, 0x13, 0x17, 0x1A, 0x1E, 0x22, 0x26, 0x2A,
	 0x2D, 0x31, 0x35, 0x39, 0x3C, 0x40, 0x44, 0x48, 0x4F, 0x57, 0x5F, 0x66,
	 0x6E, 0x75, 0x7D, 0x84, 0x8C, 0x93, 0x9B, 0xA3, 0xAA, 0xB2, 0xB9, 0xC1,
	 0xC8, 0xD0, 0xD7, 0xDF, 0xE7, 0xEA, 0xEC, 0xEE, 0xF0, 0xF1}, // LUT Num 8, L241

	{0x00, 0x04, 0x07, 0x0B, 0x0F, 0x13, 0x16, 0x1A, 0x1E, 0x22, 0x25, 0x29,
	 0x2D, 0x31, 0x34, 0x38, 0x3C, 0x40, 0x43, 0x47, 0x4F, 0x56, 0x5E, 0x65,
	 0x6D, 0x74, 0x7C, 0x83, 0x8B, 0x92, 0x9A, 0xA1, 0xA9, 0xB0, 0xB8, 0xBF,
	 0xC7, 0xCE, 0xD6, 0xDD, 0xE5, 0xE8, 0xEA, 0xEC, 0xEE, 0xEF}, // LUT Num 9, L239

	{0x00, 0x04, 0x07, 0x0B, 0x0F, 0x13, 0x16, 0x1A, 0x1E, 0x21, 0x25, 0x29,
	 0x2D, 0x30, 0x34, 0x38, 0x3B, 0x3F, 0x43, 0x47, 0x4E, 0x56, 0x5D, 0x64,
	 0x6C, 0x73, 0x7B, 0x82, 0x8A, 0x91, 0x98, 0xA0, 0xA7, 0xAF, 0xB6, 0xBE,
	 0xC5, 0xCC, 0xD4, 0xDB, 0xE3, 0xE6, 0xE8, 0xEA, 0xEC, 0xED}, // LUT Num 10, L237

	{0x00, 0x04, 0x07, 0x0B, 0x0F, 0x12, 0x16, 0x1A, 0x1D, 0x21, 0x25, 0x29,
	 0x2C, 0x30, 0x34, 0x37, 0x3B, 0x3F, 0x42, 0x46, 0x4D, 0x55, 0x5C, 0x64,
	 0x6B, 0x72, 0x7A, 0x81, 0x88, 0x90, 0x97, 0x9F, 0xA6, 0xAD, 0xB5, 0xBC,
	 0xC3, 0xCB, 0xD2, 0xD9, 0xE1, 0xE5, 0xE6, 0xE8, 0xEA, 0xEB}, // LUT Num 11, L235

	{0x00, 0x04, 0x07, 0x0B, 0x0F, 0x12, 0x16, 0x1A, 0x1D, 0x21, 0x25, 0x28,
	 0x2C, 0x30, 0x33, 0x37, 0x3A, 0x3E, 0x42, 0x45, 0x4D, 0x54, 0x5B, 0x63,
	 0x6A, 0x71, 0x79, 0x80, 0x87, 0x8F, 0x96, 0x9D, 0xA4, 0xAC, 0xB3, 0xBA,
	 0xC2, 0xC9, 0xD0, 0xD8, 0xDF, 0xE3, 0xE4, 0xE6, 0xE8, 0xE9}, // LUT Num 12, L233

	{0x00, 0x04, 0x07, 0x0B, 0x0E, 0x12, 0x16, 0x19, 0x1D, 0x21, 0x24, 0x28,
	 0x2B, 0x2F, 0x33, 0x36, 0x3A, 0x3E, 0x41, 0x45, 0x4C, 0x53, 0x5B, 0x62,
	 0x69, 0x70, 0x78, 0x7F, 0x86, 0x8D, 0x95, 0x9C, 0xA3, 0xAA, 0xB2, 0xB9,
	 0xC0, 0xC7, 0xCF, 0xD6, 0xDD, 0xE1, 0xE2, 0xE4, 0xE6, 0xE7}, // LUT Num 13, L231

	{0x00, 0x04, 0x07, 0x0B, 0x0E, 0x12, 0x16, 0x19, 0x1D, 0x20, 0x24, 0x28,
	 0x2B, 0x2F, 0x32, 0x36, 0x39, 0x3D, 0x41, 0x44, 0x4B, 0x53, 0x5A, 0x61,
	 0x68, 0x6F, 0x77, 0x7E, 0x85, 0x8C, 0x93, 0x9A, 0xA2, 0xA9, 0xB0, 0xB7,
	 0xBE, 0xC6, 0xCD, 0xD4, 0xDB, 0xDF, 0xE1, 0xE2, 0xE4, 0xE5}, // LUT Num 14, L229

	{0x00, 0x04, 0x07, 0x0B, 0x0E, 0x12, 0x15, 0x19, 0x1C, 0x20, 0x24, 0x27,
	 0x2B, 0x2E, 0x32, 0x35, 0x39, 0x3D, 0x40, 0x44, 0x4B, 0x52, 0x59, 0x60,
	 0x67, 0x6E, 0x76, 0x7D, 0x84, 0x8B, 0x92, 0x99, 0xA0, 0xA7, 0xAE, 0xB6,
	 0xBD, 0xC4, 0xCB, 0xD2, 0xD9, 0xDD, 0xDF, 0xE0, 0xE2, 0xE3}, // LUT Num 15, L227

	{0x00, 0x04, 0x07, 0x0B, 0x0E, 0x12, 0x15, 0x19, 0x1C, 0x20, 0x23, 0x27,
	 0x2A, 0x2E, 0x31, 0x35, 0x38, 0x3C, 0x40, 0x43, 0x4A, 0x51, 0x58, 0x5F,
	 0x66, 0x6D, 0x74, 0x7C, 0x83, 0x8A, 0x91, 0x98, 0x9F, 0xA6, 0xAD, 0xB4,
	 0xBB, 0xC2, 0xC9, 0xD0, 0xD7, 0xDB, 0xDD, 0xDE, 0xE0, 0xE1}, // LUT Num 16, L225

	{0x00, 0x03, 0x07, 0x0A, 0x0E, 0x11, 0x15, 0x18, 0x1C, 0x1F, 0x23, 0x26,
	 0x2A, 0x2D, 0x31, 0x34, 0x38, 0x3B, 0x3F, 0x42, 0x49, 0x50, 0x57, 0x5E,
	 0x65, 0x6C, 0x73, 0x7A, 0x81, 0x88, 0x8F, 0x96, 0x9D, 0xA4, 0xAB, 0xB2,
	 0xB9, 0xC0, 0xC7, 0xCE, 0xD5, 0xD9, 0xDB, 0xDC, 0xDE, 0xDF}, // LUT Num 17, L223

	{0x00, 0x03, 0x07, 0x0A, 0x0E, 0x11, 0x15, 0x18, 0x1C, 0x1F, 0x23, 0x26,
	 0x2A, 0x2D, 0x31, 0x34, 0x37, 0x3B, 0x3E, 0x42, 0x49, 0x50, 0x57, 0x5E,
	 0x65, 0x6B, 0x72, 0x79, 0x80, 0x87, 0x8E, 0x95, 0x9C, 0xA3, 0xAA, 0xB1,
	 0xB8, 0xBF, 0xC6, 0xCD, 0xD3, 0xD7, 0xD9, 0xDA, 0xDC, 0xDD}, // LUT Num 18, L221

	{0x00, 0x03, 0x07, 0x0A, 0x0E, 0x11, 0x15, 0x18, 0x1B, 0x1F, 0x22, 0x26,
	 0x29, 0x2D, 0x30, 0x34, 0x37, 0x3A, 0x3E, 0x41, 0x48, 0x4F, 0x56, 0x5D,
	 0x64, 0x6A, 0x71, 0x78, 0x7F, 0x86, 0x8D, 0x94, 0x9B, 0xA1, 0xA8, 0xAF,
	 0xB6, 0xBD, 0xC4, 0xCB, 0xD2, 0xD5, 0xD7, 0xD8, 0xDA, 0xDB}, // LUT Num 19, L219

	{0x00, 0x03, 0x07, 0x0A, 0x0E, 0x11, 0x14, 0x18, 0x1B, 0x1F, 0x22, 0x25,
	 0x29, 0x2C, 0x30, 0x33, 0x36, 0x3A, 0x3D, 0x41, 0x47, 0x4E, 0x55, 0x5C,
	 0x63, 0x6A, 0x70, 0x77, 0x7E, 0x85, 0x8C, 0x92, 0x99, 0xA0, 0xA7, 0xAE,
	 0xB4, 0xBB, 0xC2, 0xC9, 0xD0, 0xD3, 0xD5, 0xD6, 0xD8, 0xD9}, // LUT Num 20, L217

	{0x00, 0x03, 0x07, 0x0A, 0x0D, 0x11, 0x14, 0x18, 0x1B, 0x1E, 0x22, 0x25,
	 0x28, 0x2C, 0x2F, 0x33, 0x36, 0x39, 0x3D, 0x40, 0x47, 0x4E, 0x54, 0x5B,
	 0x62, 0x69, 0x6F, 0x76, 0x7D, 0x84, 0x8A, 0x91, 0x98, 0x9F, 0xA5, 0xAC,
	 0xB3, 0xB9, 0xC0, 0xC7, 0xCE, 0xD1, 0xD3, 0xD4, 0xD6, 0xD7}, // LUT Num 21, L215

	{0x00, 0x03, 0x07, 0x0A, 0x0D, 0x11, 0x14, 0x17, 0x1B, 0x1E, 0x21, 0x25,
	 0x28, 0x2B, 0x2F, 0x32, 0x35, 0x39, 0x3C, 0x3F, 0x46, 0x4D, 0x54, 0x5A,
	 0x61, 0x68, 0x6E, 0x75, 0x7C, 0x82, 0x89, 0x90, 0x96, 0x9D, 0xA4, 0xAA,
	 0xB1, 0xB8, 0xBE, 0xC5, 0xCC, 0xCF, 0xD1, 0xD2, 0xD4, 0xD5}, // LUT Num 22, L213
};

#define NUM_SAT_CTRL 5
#define OFFSET_SAT_CTRL 60
#define REG_SAT_CTRL 0xE6

#define NUM_HUE_CTRL 5
#define OFFSET_HUE_CTRL 13
#define REG_HUE_CTRL 0xE5

static char sat_ctrl_values[NUM_SAT_CTRL][OFFSET_SAT_CTRL] = {
	{0xE0, 0xEA, 0xF8, 0xC0, 0x55, 0xEE, 0xB3, 0xFC, 0xDA, 0x55,
	 0x70, 0x70, 0xB0, 0xA4, 0x55, 0x3F, 0x80, 0xC0, 0x9F, 0x55,
	 0x4F, 0xB0, 0xBF, 0xBE, 0x55, 0x60, 0xB3, 0xF9, 0xE0, 0x55,
	 0x80, 0xB0, 0xD0, 0xD0, 0x55, 0x80, 0xB0, 0xD0, 0xD0, 0x55,
	 0xD8, 0xC0, 0xD8, 0x80, 0x55, 0xAD, 0xA0, 0xC8, 0xB0, 0x55,
	 0xD0, 0xA0, 0xD0, 0xD0, 0x55, 0x22, 0xCD, 0xFA, 0xE0, 0x56},

	{0x10, 0x0A, 0x0C, 0xD0, 0x6A, 0x14, 0xE2, 0x13, 0xED, 0x66,
	 0xAD, 0xA3, 0xD0, 0xBC, 0x55, 0x9F, 0xB8, 0xE0, 0xC8, 0x55,
	 0xA0, 0xE8, 0xD8, 0xDA, 0x55, 0xB0, 0xF3, 0x16, 0xF0, 0x65,
	 0xC0, 0xD0, 0xE8, 0xE8, 0x55, 0xC0, 0xD0, 0xE8, 0xE8, 0x55,
	 0xEC, 0xE0, 0xF0, 0xA8, 0x55, 0xC5, 0xB0, 0xD8, 0xD0, 0x55,
	 0xE8, 0xD0, 0xE8, 0xE0, 0x55, 0x44, 0x00, 0x12, 0xF0, 0x6A},

	{0x40, 0x2A, 0x1E, 0x00, 0xAA, 0x3A, 0x11, 0x26, 0x00, 0xAA,
	 0xDD, 0xD6, 0xF0, 0xD4, 0x55, 0xFF, 0xF0, 0x00, 0x00, 0xA5,
	 0x00, 0x2A, 0x00, 0x00, 0xAA, 0x00, 0x33, 0x33, 0x00, 0xAA,
	 0x00, 0x00, 0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0x00, 0xAA,
	 0x00, 0x00, 0x00, 0x00, 0xAA, 0xDD, 0xD0, 0xF0, 0xFF, 0x55,
	 0x00, 0x00, 0x00, 0x00, 0xAA, 0x66, 0x33, 0x2A, 0x00, 0xAA},

	{0x70, 0x4E, 0x30, 0x00, 0xAA, 0x60, 0x40, 0x30, 0x00, 0xAA,
	 0x60, 0x60, 0x38, 0x00, 0xAA, 0x60, 0x60, 0x20, 0x00, 0xAA,
	 0x60, 0x7A, 0x28, 0x00, 0xAA, 0x40, 0x73, 0x50, 0x00, 0xAA,
	 0x10, 0x20, 0x10, 0x00, 0xAA, 0x08, 0x10, 0x08, 0x00, 0xAA,
	 0x07, 0x0E, 0x07, 0x00, 0xAA, 0xE5, 0xE0, 0xF8, 0xFF, 0x55,
	 0x18, 0x30, 0x18, 0x00, 0xAA, 0x80, 0x78, 0x42, 0x00, 0xAA},

	{0xA0, 0x72, 0x42, 0x00, 0xAA, 0x86, 0x6F, 0x3A, 0x00, 0xAA,
	 0xE3, 0xEA, 0x80, 0x00, 0xAA, 0xC0, 0xC0, 0x40, 0x00, 0xAA,
	 0xC0, 0xCA, 0x56, 0x00, 0xAA, 0x80, 0xB3, 0x6D, 0x00, 0xAA,
	 0x20, 0x40, 0x20, 0x00, 0xAA, 0x10, 0x20, 0x10, 0x00, 0xAA,
	 0x10, 0x20, 0x10, 0x00, 0xAA, 0xED, 0xF0, 0x00, 0x00, 0xA5,
	 0x30, 0x60, 0x30, 0x00, 0xAA, 0x9A, 0xBD, 0x5A, 0x00, 0xAA},
};

static char hue_ctrl_values[NUM_HUE_CTRL][OFFSET_HUE_CTRL] = {
	{0x06, 0xEC, 0xEB, 0xFB, 0xF0, 0xB0, 0xED, 0xFE, 0xED, 0xEB, 0xFE, 0x0A, 0xF5},
	{0x06, 0xF7, 0xFA, 0xFD, 0xF7, 0xD3, 0xF9, 0xFC, 0xF8, 0xF6, 0x09, 0x14, 0xFD},
	{0x06, 0xFF, 0xFE, 0xFE, 0xFF, 0x06, 0x00, 0xFE, 0x00, 0xFE, 0x11, 0x1C, 0x05},
	{0x06, 0x12, 0x11, 0xFF, 0x12, 0x10, 0x13, 0x00, 0x10, 0x0F, 0x22, 0x2E, 0x15},
	{0x06, 0x22, 0x20, 0x00, 0x20, 0x1A, 0x20, 0x02, 0x20, 0x20, 0x34, 0x3F, 0x25}
};

static void lge_set_custom_rgb_hx83113a(struct dsi_panel *panel, bool send_cmd)
{
	int i = 0;
	int red_index, green_index, blue_index = 0;
	char *red_payload = NULL;
	char *green_payload = NULL;
	char *blue_payload = NULL;

	if (panel == NULL) {
		pr_err("Invalid input\n");
		return;
	}

	mutex_lock(&panel->panel_lock);

	//cm_rgb_step : 0~11
	//rgb_index 0~11 + 0~12
	if (panel->lge.screen_mode == screen_mode_oled_natural) {
		pr_info("Set default rgb step for screen_mode: %d\n", panel->lge.screen_mode);
		red_index   = rgb_preset[panel->lge.cm_preset_step][RED];
		green_index = rgb_preset[panel->lge.cm_preset_step][GREEN];
		blue_index  = rgb_preset[panel->lge.cm_preset_step][BLUE];
	} else {
		red_index   = rgb_preset[panel->lge.cm_preset_step][RED] + panel->lge.cm_red_step;
		green_index = rgb_preset[panel->lge.cm_preset_step][GREEN] + panel->lge.cm_green_step;
		blue_index  = rgb_preset[panel->lge.cm_preset_step][BLUE] + panel->lge.cm_blue_step;
	}

	pr_info("red_index=(%d) green_index=(%d) blue_index=(%d)\n", red_index, green_index, blue_index);

	red_payload = get_payload_addr(panel, LGE_DDIC_DSI_RGB_LUT, IDX_RED_CTRL);
	green_payload = get_payload_addr(panel, LGE_DDIC_DSI_RGB_LUT, IDX_GREEN_CTRL);
	blue_payload = get_payload_addr(panel, LGE_DDIC_DSI_RGB_LUT, IDX_BLUE_CTRL);

	if (!red_payload || !green_payload || !blue_payload) {
		pr_err("LGE_DDIC_DSI_RGB_LUT is NULL\n");
		mutex_unlock(&panel->panel_lock);
		return;
	}

	// For RGB Update C1h params 1st ~ 46th
	for (i = 0; i < DG_CMD_COUNT; i++) {
		red_payload[i+START_DG_CTRL] = rgb_values[red_index][i];  // Update C1h params 1st ~ 46th
		green_payload[i+START_DG_CTRL] = rgb_values[green_index][i]; // Update C1h params 1st ~ 46th
		blue_payload[i+START_DG_CTRL] = rgb_values[blue_index][i]; // Update C1h params 1st ~ 46th
	}

	for (i = START_DG_CTRL; i < TOT_PARAM_COUNT; i++) {
		pr_debug("Red Reg:0x%02x [%d:0x%02x]\n", REG_RGB_CTRL, i, red_payload[i]);
	}

	for (i = START_DG_CTRL; i < TOT_PARAM_COUNT; i++) {
		pr_debug("Green Reg:0x%02x [%d:0x%02x]\n", REG_RGB_CTRL, i, green_payload[i]);
	}

	for (i = START_DG_CTRL; i < TOT_PARAM_COUNT; i++) {
		pr_debug("blue Reg:0x%02x [%d:0x%02x]\n", REG_RGB_CTRL, i, blue_payload[i]);
	}

	if (send_cmd) {
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_RGB_LUT);
	}

	mutex_unlock(&panel->panel_lock);
	return;
}

static void lge_display_control_store_hx83113a(struct dsi_panel *panel, bool send_cmd)
{
	char *dispctrl1_payload = NULL;

	if(!panel) {
		pr_err("panel not exist\n");
		return;
	}

	mutex_lock(&panel->panel_lock);

	dispctrl1_payload = get_payload_addr(panel, LGE_DDIC_DSI_DISP_CTRL_COMMAND_1, 0);

	if (!dispctrl1_payload) {
		pr_err("LGE_DDIC_DSI_DISP_CTRL_COMMAND is NULL\n");
		mutex_unlock(&panel->panel_lock);
		return;
	}

	dispctrl1_payload[1] &= 0x00;

	/* Color Adjustment(SATURATION)_EN */
	dispctrl1_payload[1] |= panel->lge.color_manager_status << 2;
	/* HUE_ROTATION_EN */
	dispctrl1_payload[1] |= panel->lge.dgc_status;
	/* LA_EN */
	dispctrl1_payload[1] |= panel->lge.dgc_status << 5;

	pr_info("ctrl-command-1: 0x%02x", dispctrl1_payload[1]);

	if (send_cmd) {
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_DISP_CTRL_COMMAND_1);
	}

	mutex_unlock(&panel->panel_lock);
	return;
}

static void lge_set_screen_tune_hx83113a(struct dsi_panel *panel)
{
	int i;
	int sat_index = 0;
	int hue_index = 0;

	char *sat_payload = NULL;
	char *hue_payload = NULL;

	mutex_lock(&panel->panel_lock);

	sat_payload = get_payload_addr(panel, LGE_DDIC_DSI_SET_SATURATION, 0);
	hue_payload = get_payload_addr(panel, LGE_DDIC_DSI_SET_HUE, 1);

	if (!sat_payload) {
		pr_err("LGE_DDIC_DSI_SET_SATURATION is NULL\n");
		mutex_unlock(&panel->panel_lock);
		return;
	}

	if (!hue_payload) {
		pr_err("LGE_DDIC_DSI_SET_HUE is NULL\n");
		mutex_unlock(&panel->panel_lock);
		return;
	}

	sat_index = panel->lge.sc_sat_step;
	hue_index = panel->lge.sc_hue_step;

	// SATURATION CTRL
	for (i = 0; i < OFFSET_SAT_CTRL; i++) {
		sat_payload[i+1] = sat_ctrl_values[sat_index][i];
	}

	// HUE CTRL
	for (i = 0; i < OFFSET_HUE_CTRL; i++) {
		hue_payload[i+1] = hue_ctrl_values[hue_index][i];
	}

	for (i = 0; i < OFFSET_SAT_CTRL; i++) {
		pr_debug("Reg:0x%02x [%d:0x%02x]\n", REG_SAT_CTRL, i, sat_payload[i]);
	}
	for (i = 0; i < OFFSET_HUE_CTRL; i++) {
		pr_debug("Reg:0x%02x [%d:0x%02x]\n", REG_HUE_CTRL, i, hue_payload[i]);
	}

	lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_SATURATION);
	lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_HUE);

	mutex_unlock(&panel->panel_lock);

	return;
}

static void lge_set_screen_mode_hx83113a(struct dsi_panel *panel, bool send_cmd)
{
	mutex_lock(&panel->panel_lock);

	pr_info("screen_mode %d\n", panel->lge.screen_mode);

	switch (panel->lge.screen_mode) {
	case screen_mode_oled_natural:
		panel->lge.dgc_status = 0x01;
		panel->lge.color_manager_status = 0x01;
		pr_info("natural mode\n");
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_CM_NATURAL);

		mutex_unlock(&panel->panel_lock);
		lge_set_custom_rgb_hx83113a(panel, send_cmd);
		mutex_lock(&panel->panel_lock);
		break;
	case screen_mode_oled_vivid:
		panel->lge.dgc_status = 0x01;
		panel->lge.color_manager_status = 0x01;
		pr_info("vivid mode\n");
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_CM_VIVID);
		break;
	case screen_mode_oled_custom:
		pr_info("preset: %d, red: %d, green: %d, blue: %d\n",
				panel->lge.cm_preset_step, panel->lge.cm_red_step,
				panel->lge.cm_green_step, panel->lge.cm_blue_step);
		pr_info("saturation: %d, hue: %d\n",
				panel->lge.sc_sat_step, panel->lge.sc_hue_step);

		panel->lge.dgc_status = 0x01;
		panel->lge.color_manager_status = 0x01;

		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_SATURATION_DEFAULT);
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_HUE_DEFAULT);

		mutex_unlock(&panel->panel_lock);
		lge_set_screen_tune_hx83113a(panel);
		lge_set_custom_rgb_hx83113a(panel, send_cmd);
		mutex_lock(&panel->panel_lock);
		break;
	default:
		panel->lge.dgc_status = 0x01;
		panel->lge.color_manager_status = 0x01;

		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_SATURATION_DEFAULT);
		lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_SET_HUE_DEFAULT);
		break;
	}

	mutex_unlock(&panel->panel_lock);
	lge_display_control_store_hx83113a(panel, send_cmd);
	return;
}

static void lge_update_ddic_hdr_status(struct dsi_panel *panel)
{
	panel->lge.ddic_hdr = !!(panel->lge.ve_hdr | panel->lge.ace_hdr);
	pr_info("hdr %d ve_hdr %d ace_hdr %d \n", panel->lge.ddic_hdr, panel->lge.ve_hdr, panel->lge.ace_hdr);
}

static void lge_set_video_enhancement_hx83113a(struct dsi_panel *panel, int input)
{
	int rc = 0;
	bool enable = false;

	mutex_lock(&panel->panel_lock);

	panel->lge.ve_hdr = input;
	lge_update_ddic_hdr_status(panel);
	enable = panel->lge.ddic_hdr;

	if (enable) {
		rc = lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_VIDEO_ENHANCEMENT_ON);
		if (rc)
			pr_err("failed to send VIDEO_ENHANCEMENT_ON cmd, rc=%d\n", rc);
	}
	else {
		rc = lge_ddic_dsi_panel_tx_cmd_set(panel, LGE_DDIC_DSI_VIDEO_ENHANCEMENT_OFF);
		if (rc)
			pr_err("failed to send VIDEO_ENHANCEMENT_OFF cmd, rc=%d\n", rc);
		mutex_unlock(&panel->panel_lock);
		lge_set_screen_mode_hx83113a(panel,true);
		mutex_lock(&panel->panel_lock);
	}
	mutex_unlock(&panel->panel_lock);

	pr_info("send cmds to %s the video enhancer \n",
		(input == true) ? "enable" : "disable");

	//lge_backlight_device_update_status(panel->bl_config.raw_bd);
}

static int lge_hdr_mode_set_hx83113a(struct dsi_panel *panel, int input)
{
	bool hdr_mode = ((input > 0) ? true : false);

	mutex_lock(&panel->panel_lock);
	if (hdr_mode) {
		panel->lge.color_manager_status = 0;
		panel->lge.dgc_status = 0x00;
	} else {
		panel->lge.color_manager_status = 1;
		panel->lge.dgc_status = 1;
	}
	mutex_unlock(&panel->panel_lock);
	pr_info("hdr=%s, cm=%s dgc=%s\n", (hdr_mode ? "set" : "unset"),
			((panel->lge.color_manager_status == 1) ? "enabled" : "disabled"),
			((panel->lge.dgc_status == 1) ? "enabled" : "disabled"));

	if (hdr_mode) {
		lge_display_control_store_hx83113a(panel, true);
	} else {
		lge_set_screen_mode_hx83113a(panel, true);
	}

	//lge_backlight_device_update_status(panel->bl_config.raw_bd);

	return 0;
}

void lge_panel_dsv_ctrl_hx83113a(struct dsi_panel *panel, bool enable)
{
#if defined(CONFIG_MFD_DW8768)
	int rc = 0;

	if(enable) {
		if (gpio_is_valid(panel->lge.dsv_ena_gpio_dw8768)) {
			if (gpio_direction_output(panel->lge.dsv_ena_gpio_dw8768, 1))
				pr_err("[Display] unable to set DSV ena gpio rc=%d\n", rc);
			else {
				dw8768_register_set(DW8768_VPOS_VOLTAGE_REG, 0x0F); // +5.2V
				usleep_range(500, 500);
				dw8768_register_set(DW8768_VNEG_VOLTAGE_REG, 0x0F); // -5.2V
				usleep_range(500, 500);
				dw8768_register_set(DW8768_ENABLE_REG, 0x0F); // enable
				usleep_range(5000, 5000);
				pr_err("[Display] DSV on(dw8768)\n");
			}
		}
	} else {
		dw8768_register_set(DW8768_ENABLE_REG, /* disable */0x07);
		if (gpio_is_valid(panel->lge.dsv_ena_gpio_dw8768)) {
			rc = gpio_direction_output(panel->lge.dsv_ena_gpio_dw8768, 0);
			if (rc)
				pr_err("[Display]unable to set dir for vpnl gpio rc=%d\n", rc);
			else {
				pr_err("[Display] DSV off(dw8768)\n");
			}
		}
	}
#endif
}

struct lge_ddic_ops hx83113a_ops = {
	/* aod */
	.store_aod_area = NULL,
	.prepare_aod_cmds = NULL,
	.prepare_aod_area = NULL,
	.lge_check_vert_black_line = NULL,
	.lge_check_vert_white_line = NULL,
	.lge_check_vert_line_restore = NULL,
	/* brightness */
	.lge_bc_dim_set = NULL,
	.lge_set_therm_dim = NULL,
	.lge_get_brightness_dim = NULL,
	.lge_set_brightness_dim = NULL,
	/* image quality */
	.hdr_mode_set = lge_hdr_mode_set_hx83113a,
	.lge_set_custom_rgb = lge_set_custom_rgb_hx83113a,
	.lge_display_control_store = lge_display_control_store_hx83113a,
	.lge_set_screen_tune = lge_set_screen_tune_hx83113a,
	.lge_set_screen_mode = lge_set_screen_mode_hx83113a,
	.sharpness_set = NULL,
	.lge_set_true_view_mode = NULL,
	.lge_set_video_enhancement = lge_set_video_enhancement_hx83113a,
	/* drs */
	.get_current_res = NULL,
	.get_support_res = NULL,
	/* bist */
	.bist_ctrl = NULL,
	.release_bist = NULL,
	/* error detect */
	.err_detect_work = NULL,
	.err_detect_irq_handler = NULL,
	.set_err_detect_mask = NULL,
	/* pps */
	.set_pps_cmds = NULL,
	.unset_pps_cmds = NULL,
	/* irc */
	.set_irc_default_state = NULL,
	.set_irc_state = NULL,
	.get_irc_state = NULL,
	/* lhbm */
	.lge_set_fp_lhbm = NULL,
	.lge_panel_dsv_ctrl = lge_panel_dsv_ctrl_hx83113a,
};

